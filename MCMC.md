# MCMC

## 1. Introduction

最近的一项调查将 Metropolis 算法列为对 20 世纪科学和工程的发展和实践影响最大的十种算法（Beichl&Sullivan，2000）。 该算法是一大类采样算法的一个实例，称为马尔可夫链蒙特卡罗（MCMC）。 在过去的二十年里，这些算法在统计学、计量经济学、物理学和计算科学领域发挥了重要作用。 有几个高维问题，例如计算 d 维凸体的体积，对于这些问题，MCMC 模拟是唯一已知的在合理时间内提供解决方案的通用方法（d 中的多项式）（Dyer、Frieze 和 坎南，1991 年；杰鲁姆和辛克莱，1996 年）。

在 1946 年病愈期间，斯坦·乌拉姆 (Stan Ulam) 正在玩纸牌游戏。 然后，他想到要尝试计算具有 52 张牌的特定单人纸牌成功推出的几率（Eckhard，1987）。 在尝试了详尽的组合计算后，他决定采用更实用的方法，随机布置几个纸牌，然后观察和计算成功播放的次数。 选择统计样本以通过更简单的问题来近似困难的组合问题的想法是现代蒙特卡罗模拟的核心

Stan Ulam 很快意识到计算机可以以这种方式用于回答中子扩散和数学物理问题。 他联系了约翰·冯·诺依曼，后者了解这个想法的巨大潜力。 在接下来的几年里，乌拉姆和冯诺依曼开发了许多蒙特卡罗算法，包括重要性采样和拒绝采样。  Enrico Fermi 在 1930 年代也使用蒙特卡罗来计算中子扩散，后来设计了 FERMIAC，一种执行计算的蒙特卡罗机械装置（Anderson，1986）。 在 1940 年代，年轻的物理学家 Nick Metropolis 与约翰的妻子 Klari Von Neumann 一起为最先进的计算机 (ENIAC) 设计了新的控制装置。 他着迷于蒙特卡罗方法和这种新的计算设备。

很快，他设计了一台经过改进的计算机，并将其命名为 MANIAC，希望计算机科学家不再使用首字母缩略词。 在他从事计算机工作期间，许多数学家和物理学家（费米、冯诺依曼、乌拉姆、泰勒、里希迈尔、贝特、费曼和伽莫夫）会带着他们的工作问题去找他。

最终在 1949 年，他与 Stan Ulam 发表了关于蒙特卡罗模拟的第一个公开文件（Metropolis & Ulam，1949）。 本文介绍了蒙特卡罗粒子方法等思想，它构成了现代顺序蒙特卡罗方法的基础，例如自举滤波器、凝聚和适者生存算法 (Doucet, de Freitas, & Gordon, 2001)。 不久之后，他与 Tellers 和 Rosenbluths 提出了 Metropolis 算法（Metropolis 等，1953）

1953 年后，物理学文献中出现了许多关于蒙特卡罗模拟的论文。从推理的角度来看，最重要的贡献是 Hastings 在 1970 年对 Metropolis 算法的推广。 Hastings 和他的学生 Peskun 表明 Metropolis 和更一般的 Metropolis-Hastings 算法是一大类算法的特例，其中还包括 玻尔兹曼算法（Hastings，1970；Peskun，1973）。 他们研究了这些算法的最优性，并介绍了我们在本文中采用的 Metropolis-Hastings 算法的公式。 在 1980 年代，两篇重要的 MCMC 论文出现在计算机视觉和人工智能领域（Geman & Geman，1984；Pearl，1987）。 尽管此时在统计学文献中存在一些 MCMC 出版物，但人们普遍认为 MCMC 仅在 1990 年才对统计学产生了第一次重大影响（Gelfand & Smith，1990）。 在神经网络文献中，Neal (1996) 的出版物特别有影响力。

在本期特刊的介绍中，我们专注于描述我们认为是现代 MCMC 程序中主要构建块的算法。 我们应该强调，为了从此类算法中获得最佳结果，重要的是我们不要将它们视为黑匣子，而是尝试将尽可能多的领域特定知识纳入其设计中。  MCMC 算法通常需要设计提议机制来生成候选假设。 许多现有的机器学习算法可以适应成为提案机制（de Freitas 等，2001）。 这对于获得快速收敛的 MCMC 算法通常是必不可少的。 除此之外，我们相信机器学习社区可以为解决 MCMC 领域的许多开放问题做出重大贡献。 为此，我们在本文末尾概述了几个“热门”研究方向。 最后，鼓励读者参考 Chen、Shao 和 Ibrahim（2001）、Gilks、Richardson 和 Spiegelhalter（1996）、Liu（2001）、Meyn 和 Tweedie（1993）、Robert 和 Casella（1999）以及 Besag 等人的评论论文。  (1995)、Brooks (1998)、Diaconis 和 Saloff-Coste (1998)、Jerrum 和 Sinclair (1996)、Neal (1993) 和 Tierney (1994)，了解有关 MCMC 的更多信息。

本文的其余部分组织如下。 在第 2 部分中，我们概述了一般问题并介绍了简单的 Monte Carlo 模拟、拒绝抽样和重要性抽样。 第 3 部分介绍 MCMC 和最流行的 MCMC 算法。 在第 4 部分中，我们描述了一些重要的研究前沿。 为了使论文更易于理解，我们在可逆跳跃 MCMC 部分之前没有对分布和密度进行符号区分。

## 2. MCMC motivation

MCMC 技术通常用于解决大维空间中的集成和优化问题。 这两类问题在机器学习、物理学、统计学、计量经济学和决策分析中都发挥着基础性作用。 以下只是一些示例。

1.贝叶斯推理和学习。 给定一些未知变量 $x ∈ X$​ 和数据 $y ∈ Y$，以下通常难以处理的集成问题是贝叶斯统计的核心

(a) 归一化。 为了获得给定先验 $p(x)$​​ 和似然 $p(y | x)$​ 的后验 $p(x | y)$，需要计算贝叶斯定理中的归一化因子

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830004425879.png" alt="image-20210830004425879" style="zoom:67%;" />

(b) 边缘化。 鉴于 $(x, z) ∈ X × Z$ 的联合后验，我们可能经常对边缘后验感兴趣

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830004503502.png" alt="image-20210830004503502" style="zoom:67%;" />

(c) 期望。 分析的目标通常是获得以下形式的汇总统计量

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830004527056.png" alt="image-20210830004527056" style="zoom:67%;" />

对于一些感兴趣的函数 $f ： X → \R ^n f$​ 可关于 $p(x | y)$ 积分。

 适当函数的示例包括条件均值，在这种情况下 $f (x) = x$​，或 $x$​ 的条件协方差，其中 $f (x) = xx' −E_{ p(x|y)}(x)E '_{p(x|y)}  (X)$。

2. 统计力学。 这里，需要计算具有状态 $s$​ 和哈密顿量 $E(s)$ 的系统的配分函数 $Z$

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830004822802.png" alt="image-20210830004822802" style="zoom:67%;" />

其中 k 是玻尔兹曼常数，T 表示系统的温度。对大量可能的配置进行总结是非常昂贵的（Baxter，1982）。 请注意，计算分区函数和统计推断中的归一化常数的问题是类似的。

3.优化。 优化的目标是从一大组可行解中提取最小化某个目标函数的解。 事实上，这个集合可以是连续的和无界的。 通常，比较所有解决方案以找出哪个解决方案在计算上过于昂贵。

4.惩罚似然模型选择。 此任务通常包括两个步骤。 首先，分别找到每个模型的最大似然 (ML) 估计。 然后使用惩罚项（例如 MDL、BIC 或 AIC）来选择模型之一。 这种方法的问题在于初始模型集可能非常大。 此外，其中许多模型不感兴趣，因此浪费了计算资源。

尽管我们强调了集成和优化，但 MCMC 在物理系统的模拟中也起着基础性的作用。 这与核物理和计算机图形学非常相关（Chenney & Forsyth，2000；Kalos & Whitlock，1986；Veach & Guibas，1997）。

### 2.1. The Monte Carlo principle

蒙特卡罗模拟的思想是绘制一个 i.i.d. 样本集 $\{x^{(i )}\}^N _{i=1}$​ ，该样本集来自在高维空间 $X$​ 上定义的目标密度 $p(x)$（例如系统的可能配置集，后验定义的空间，或 可行解的组合集）。 这 N 个样本可用于通过以下经验点质量函数来近似目标密度

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830005225381.png" alt="image-20210830005225381" style="zoom:67%;" />

其中 $δ_{x^{(i )}} (x)$​ 表示位于 $x^{(i )}$ 处的 delta-Dirac 质量。 因此，我们可以用可处理的 $I(f)$ 来近似积分（或非常大的和），其收敛如下

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830005504691.png" alt="image-20210830005504691" style="zoom:67%;" />

也就是说，估计 $I_N ( f )$​​​​​ 是无偏的，并且根据强数定律，它几乎肯定会 (a.s.) 收敛到 $I ( f )$​​​​。 如果 $f (x)$​​​ 的方差（为简单起见，在单变量情况下）满足 $σ^2_f= E_{p(x)}( f ^2(x)) − I ^2( f ) < ∞$​​，则估计量 $I_N ( f )$​ 的方差为 等于 $var(I_N ( f )) = \frac{σ^2_f} N$ 并且中心极限定理产生误差分布的收敛

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830005811482.png" alt="image-20210830005811482" style="zoom:67%;" />

其中 ⇒ 表示分布收敛（Robert & Casella，1999；第 3.2 节）。蒙特卡罗积分相对于确定性积分的优势在于前者将积分网格（样本）定位在高概率区域中。

N 个样本也可用于获得目标函数 $p(x)$ 的最大值，如下所示

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830010105308.png" alt="image-20210830010105308" style="zoom:67%;" />

然而，我们稍后将展示构建模拟退火算法是可能的，该算法允许我们从支持为全局最大值集的分布中进行近似采样。

当 p(x) 具有标准形式时，例如 高斯，使用易于获得的例程从中采样很简单。 然而，当情况并非如此时，我们需要引入基于拒绝采样、重要性采样和 MCMC 的更复杂的技术。

### 2.2. Rejection sampling

我们可以通过从满足 $p(x) ≤ Mq(x)$​​​​​, $M < ∞$​​​​ 的另一个易于采样的提议分布 $q(x)$​​​ 中采样，从分布 $p(x)$​​ 中采样，该分布已知达到比例常数 ，使用图 1 中描述的接受/拒绝程序（另请参见图 2）。可以很容易地证明接受的 $x(i)$​ 以概率 $p(x)$ 进行采样（Robert &

![image-20210830010340174](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830010340174.png)

图 1. 拒绝采样算法。对该算法的注解：采样样本 $x^{(i)}$ 符合我们所选取的，容易采样的先验分布 $q(x)$ , u 则是符合均匀分布的随机变量，其取值范围位于区间 $[0,1]$ ，$p(x^{(i)})$ 则指的是实际分布的采样点

![image-20210830010828663](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830010828663.png)

图 2. 拒绝抽样：对候选 $x^{(i)}$​ 和均匀分布变量 u 进行抽样。 如果 $uMq(x^{(i )}) < p(x^{(i )})$，则接受候选样本，否则拒绝它。

卡塞拉, 1999, p.  49)。 这种简单的方法受到严重的限制。 在整个空间 $X$​ 上用一个合理的常数 $M$​ 来限制 $p(x)/q(x)$ 并不总是可能的。如果 $M$ 太大，接受概率

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830011101608.png" alt="image-20210830011101608" style="zoom:67%;" />

会太小。 这使得该方法在高维场景中不切实际

### 2.3. Importance sampling

重要性采样是一种可追溯到 1940 年代的替代“经典”解决方案； 参见例如 (Geweke, 1989; Rubinstein, 1981)。 让我们再次引入任意重要性提议分布 $q(x)$​​，使其支持包括对 $p(x)$​ 的支持。那么我们可以将 $I ( f )$ 改写如下 
$$
I(f)=\int f(x)w(x)q(x)dx
$$
其中 $w(x)= \frac{p(x)}{ q(x)}$​ 被称为重要性权重。 因此，如果可以模拟 N i.i.d. 样本 $\{x^{(i )}\}^N _{i=1}$​ 根据 $q(x)$​ 并评估 $w(x^{(i )})，I ( f )$ 的可能的蒙特卡罗估计是

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830011818074.png" alt="image-20210830011818074" style="zoom:67%;" />

这个估计量是无偏的，在弱假设下，强数定律适用，即 $\hat{I}_ N( f )→_{N\to\infin}I(f)$​​​
很明显，这种积分方法也可以解释为一种采样方法，其中后验密度 $p(x)$​​ 近似为

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830012201062.png" alt="image-20210830012201062" style="zoom:67%;" />

并且 $\hat{I} _N ( f )$​​ 仅仅只是函数 $f (x)$ 与经验测度函数 $\hat{p}_N(x)$ 乘积的积分。

一些提案分布 $q(x)$​​​ 显然比其他的更可取。 选择最优建议分布的一个重要标准是要使  $\hat{I}_N ( f )$​​ 的方差最小。  $f (x)w(x)$​ 相对于 $q(x)$ 的方差由下式给出 

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830013152255.png" alt="image-20210830013152255" style="zoom:67%;" />

右边的第二项不依赖于 q(x)，因此我们只需要最小化第一项，根据 Jensen 不等式，它有以下下界

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830013306379.png" alt="image-20210830013306379" style="zoom:67%;" />

当我们采用以下最优重要性分布时，就达到了这个下界

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830013349479.png" alt="image-20210830013349479" style="zoom:67%;" />

最佳建议不是很有用，因为它不容易从中采样 $|  f(x)|p(x)$​​。 然而，它告诉我们，当我们专注于在重要区域从 $p(x)$​ 采样时，可以获得高采样效率：  $|f(x)|p(x)$比较大； 因此称为重要性采样。

这个结果意味着重要性抽样估计可能是非常有效的。 也就是说，对于给定的函数 $f (x)$​​，有可能找到一个分布 $q(x)$​，它产生的估计方差比使用完美的蒙特卡罗方法时更低，即 $q(x)= p(x)$  ）。

这个特性经常被用来评估通信网络中罕见事件的概率（Smith, Shafi, & Gao, 1997）。 感兴趣的数量是尾部概率（误码率），因此 $f (x)=\mathbb{I} _E (x)$​​​ 其中 $\mathbb{I}_E (x)=1$​​​ 如果 $x ∈ E$​​，否则为 0（参见图 3）。 通过根据 $q(x)∝\mathbb{I}_E (x)p(x)$​​ 进行采样，可以比根据 $q(x)= p(x)$​ 更有效地估计误码率。 也就是说，在没有效用的区域提出候选人是浪费的。 在许多应用中，目标通常是不同的，因为人们希望得到 $p(x)$ 的良好近似，而不是关于 p(x) 的特定积分，因此我们经常寻求 $q(x)  \simeq p(x)$。

随着 x 维度的增加，获得合适的 q(x) 来抽取样本变得越来越困难。 一个明智的策略是采用参数化的 q(x, θ) 并在模拟过程中调整 θ。 自适应重要性采样似乎起源于结构安全文献（Bucher，1988），并已广泛应用于通信文献（Al-Qaq、Devetsikiotis 和 Townsend，1995；Remondo 等，2000）。 这种技术最近也在机器学习社区中得到了利用（de Freitas 等，2000；Cheng & Druzdzel，2000；Ortiz & Kaelbling，2000；Schuurmans & Southey，2000）。 一种流行的自适应策略涉及计算方程右侧第一项的导数。  (8)

重采样方案引入了一些额外的蒙特卡罗变化。 因此，尚不清楚 SIR 程序是否可以带来总体上的实际收益。 但是，在第 4.3 节中描述的顺序蒙特卡罗设置中，必须执行此重采样步骤。

我们在本节结束时指出，即使有适应，通常也不可能同时获得易于采样和良好近似的建议分布。 为此，我们需要引入更复杂的基于马尔可夫链的采样算法。

\3. MCMC algorithms

MCMC 是一种在使用马尔可夫链机制探索状态空间 X 的同时生成样本 x(i) 的策略。 这种机制的构建是为了让链在最重要的区域花费更多的时间。 特别是，它的构造使得样本 x(i) 模仿从目标分布 p(x) 中抽取的样本。  （我们重申，当我们不能直接从 p(x) 抽取样本时，我们使用 MCMC，但可以将 p(x) 评估为归一化常数。）在有限状态空间上引入马尔可夫链是直观的，其中 x(i) 只能取 s 个离散值 x(i ) ∈X = {x1, x2, .  .  .  , xs}。 随机过程 x(i) 称为马尔可夫链，如果

如果初始状态的概率向量为 μ(x(1)) = (0.5, 0.2, 0.3)，则得出 μ(x(1))T = (0.2, 0.6, 0.2) 并且经过多次迭代后 ( 乘以 T )，乘积 μ(x(1))T t 收敛到 p(x) = (0.2, 0.4, 0.4)。 无论我们使用什么初始分布 μ(x(1))，链都会稳定在 p(x)=(0.2, 0.4, 0.4)。 该稳定性结果在 MCMC 模拟中起着重要作用。 对于任何起点，只要 T 是服从以下属性的随机转移矩阵，链就会收敛到不变分布 p(x)： 

1. 不可约性。 对于马尔可夫链的任何状态，访问所有其他状态的概率为正。 即矩阵T不能被约化为分离出更小的矩阵，这也等同于说明转移图是连通的。

   2. 非周期性。 链条不应陷入循环中。

         确保特定 p(x) 是所需不变分布的充分但非必要条件是以下可逆性（详细平衡）条件

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210830014325246.png" alt="image-20210830014325246" style="zoom:67%;" />

Summing both sides over x(i−1), gives us

MCMC 采样器是不可约且非周期性的马尔可夫链，其目标分布为不变分布。 设计这些采样器的一种方法是确保满足详细的平衡。 然而，设计快速收敛的采样器也很重要。
   事实上，我们的大部分努力将致力于提高收敛速度。
   谱理论为我们提供了对问题的有用见解。 注意 p(x) 是矩阵 T 的左特征向量，对应的特征值为 1。实际上，线性代数的 Perron-Frobenius 定理告诉我们剩余的特征值的绝对值小于 1。第二大特征值，因此， 决定链的收敛速度，应该尽可能小。
   一旦我们意识到不可约性、非周期性和不变性在我们生活中扮演的重要角色，就可以更好地理解它们。 当我们在万维网上搜索信息时，我们通常会遵循一组链接（Berners-Lee 等，1994）。 我们可以将网页和链接分别解释为马尔可夫链转移图中的节点和有向连接。 显然，我们（例如，网络上的随机游走者）希望避免陷入循环（非周期性）并希望能够访问所有现有网页（不可还原性）。 现在让我们考虑一下搜索引擎 Google 使用的流行信息检索算法，即 PageRank（Page 等，1998）。  PageRank 需要定义具有两个分量 T = L+E 的转换矩阵。  L 是一个大的链接矩阵，行和列对应于网页，因此条目 Li, j 表示从网页 i 到网页 j 的标准化链接数。  E 是一个小幅度的均匀随机矩阵，它被添加到 L 以确保不可约性和非周期性。 也就是说，噪声的加入可以防止我们陷入循环，因为它确保总是有一定的概率跳转到 Web 上的任何地方。 从我们之前的讨论中，我们有 p





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































